services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    stop_grace_period: 1m
    shm_size: 256mb
    environment:
      POSTGRES_DB: ${POSTGRES_DB:?POSTGRES_DB is required}
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      APP_DB_USER: ${APP_DB_USER:?APP_DB_USER is required}
      APP_DB_PASSWORD: ${APP_DB_PASSWORD:?APP_DB_PASSWORD is required}
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_INITDB_ARGS: --auth-host=scram-sha-256 --auth-local=scram-sha-256 --data-checksums
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h 127.0.0.1 -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - backend

  postgres-init:
    image: postgres:16-alpine
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_DB: ${POSTGRES_DB:?POSTGRES_DB is required}
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      APP_DB_USER: ${APP_DB_USER:?APP_DB_USER is required}
      APP_DB_PASSWORD: ${APP_DB_PASSWORD:?APP_DB_PASSWORD is required}
    entrypoint: ["/bin/sh", "/scripts/01-create-app-user.sh"]
    volumes:
      - ./docker/postgres/init:/scripts:ro
    networks:
      - backend

  postgres-backup:
    image: postgres:16-alpine
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: ${POSTGRES_DB:?POSTGRES_DB is required}
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      BACKUP_KEEP_DAYS: ${POSTGRES_BACKUP_KEEP_DAYS:-14}
      BACKUP_INTERVAL_SECONDS: ${POSTGRES_BACKUP_INTERVAL_SECONDS:-86400}
    entrypoint: >
      /bin/sh -c "
      set -eu;
      while true; do
        ts=$$(date -u +%Y%m%dT%H%M%SZ);
        if pg_dump --host=$${POSTGRES_HOST} --username=$${POSTGRES_USER} --dbname=$${POSTGRES_DB} --format=custom --file=/backups/$${POSTGRES_DB}-$${ts}.dump; then
          find /backups -type f -name '*.dump' -mtime +$${BACKUP_KEEP_DAYS} -delete;
        fi;
        sleep $${BACKUP_INTERVAL_SECONDS};
      done
      "
    volumes:
      - postgres_backups:/backups
    networks:
      - backend

  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001" --address ":9000"
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY_ID:?S3_ACCESS_KEY_ID is required}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_ACCESS_KEY:?S3_SECRET_ACCESS_KEY is required}
    volumes:
      - minio_data:/data
    networks:
      - backend

  minio-init:
    image: minio/mc:latest
    restart: "no"
    depends_on:
      minio:
        condition: service_started
    entrypoint: >
      /bin/sh -c "
      until mc alias set local http://minio:9000 ${S3_ACCESS_KEY_ID:?S3_ACCESS_KEY_ID is required} ${S3_SECRET_ACCESS_KEY:?S3_SECRET_ACCESS_KEY is required}; do
        echo 'Waiting for MinIO to be ready...';
        sleep 2;
      done;
      mc mb --ignore-existing local/${S3_BUCKET:?S3_BUCKET is required};
      mc anonymous set private local/${S3_BUCKET:?S3_BUCKET is required};
      "
    networks:
      - backend

  cms:
    build:
      context: .
      dockerfile: docker/cms.Dockerfile
      args:
        S3_BUCKET: ${S3_BUCKET:?S3_BUCKET is required}
        S3_REGION: ${S3_REGION:-us-east-1}
        S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:?S3_ACCESS_KEY_ID is required}
        S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:?S3_SECRET_ACCESS_KEY is required}
        S3_ENDPOINT: http://minio:9000
        S3_FORCE_PATH_STYLE: "true"
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      minio:
        condition: service_started
      minio-init:
        condition: service_completed_successfully
    environment:
      NODE_ENV: production
      HOSTNAME: 0.0.0.0
      PORT: "3000"
      NEXT_TELEMETRY_DISABLED: "1"
      DATABASE_URL: postgresql://${APP_DB_USER:?APP_DB_USER is required}:${APP_DB_PASSWORD:?APP_DB_PASSWORD is required}@postgres:5432/${POSTGRES_DB:?POSTGRES_DB is required}
      PAYLOAD_SECRET: ${PAYLOAD_SECRET:?PAYLOAD_SECRET is required}
      S3_BUCKET: ${S3_BUCKET:?S3_BUCKET is required}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:?S3_ACCESS_KEY_ID is required}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:?S3_SECRET_ACCESS_KEY is required}
      S3_ENDPOINT: http://minio:9000
      S3_FORCE_PATH_STYLE: "true"
    expose:
      - "3000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'node -e "fetch(''http://127.0.0.1:3000'').then((res)=>process.exit(res.status < 500 ? 0 : 1)).catch(()=>process.exit(1))"',
        ]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - backend
      - edge

  docs:
    build:
      context: .
      dockerfile: docker/docs.Dockerfile
      args:
        DOCS_CMS_URL: ${DOCS_CMS_URL:-http://cms:3000}
        DOCS_ALLOW_LOCAL_IP: ${DOCS_ALLOW_LOCAL_IP:-true}
    restart: unless-stopped
    depends_on:
      cms:
        condition: service_healthy
    environment:
      NODE_ENV: production
      HOSTNAME: 0.0.0.0
      PORT: "3000"
      NEXT_TELEMETRY_DISABLED: "1"
      DOCS_CMS_URL: ${DOCS_CMS_URL:-http://cms:3000}
      DOCS_ALLOW_LOCAL_IP: ${DOCS_ALLOW_LOCAL_IP:-true}
      DOCS_INCLUDE_DRAFTS: ${DOCS_INCLUDE_DRAFTS:-false}
      DOCS_EMAIL: ${DOCS_EMAIL:-}
      DOCS_PASSWORD: ${DOCS_PASSWORD:-}
    expose:
      - "3000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'node -e "fetch(''http://127.0.0.1:3000'').then((res)=>process.exit(res.status < 500 ? 0 : 1)).catch(()=>process.exit(1))"',
        ]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - edge

networks:
  edge:
    driver: bridge
  backend:
    driver: bridge
    internal: true

volumes:
  postgres_data:
  postgres_backups:
  minio_data:
